<!DOCTYPE html>
<html lang="id">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warung Jastip Yanoshi</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #076eb3; 
            --contact-color: #25d366;
            --accent-color: #076eb3;
            --bg-color: #f4f4f9;
            --text-color: #333;
            --white: #ffffff;
            --gray: #ecf0f1;
            --black: #000000;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--white);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* --- HEADER --- */
        .main-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background-color: var(--white);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        .logo-container img { height: 40px; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .cart-icon { position: relative; font-size: 1.8rem; color: var(--primary-color); cursor: pointer; }
        #cart-count {
            position: absolute; top: -5px; right: -10px; background-color: var(--accent-color);
            color: var(--white); border-radius: 50%; padding: 2px 6px;
            font-size: 0.7rem; font-weight: bold; display: none;
        }
        .hamburger-menu { cursor: pointer; font-size: 1.8rem; color: var(--primary-color); }

        /* --- Navigasi Samping --- */
        .sidenav {
            height: 100%; width: 0; position: fixed; z-index: 1001; top: 0; left: 0;
            background-color: var(--primary-color); overflow-x: hidden;
            transition: 0.5s ease-in-out; padding-top: 60px;
        }
        .sidenav a, .sidenav .nav-link, .dropdown-btn {
            padding: 10px 15px 10px 32px; text-decoration: none; font-size: 0.8rem;
            color: var(--gray); display: block; transition: 0.3s; cursor: pointer;
            border: none; background: none; width: 100%; text-align: left;
        }
        .sidenav a:hover, .sidenav .nav-link:hover, .dropdown-btn:hover { color: var(--secondary-color); }
        .sidenav .close-btn { position: absolute; top: 15px; right: 25px; font-size: 36px; color: var(--white); }
        .dropdown-content { display: none; background-color: #2c3e50; padding-left: 20px; }
        .dropdown-content a { font-size: 0.7rem; padding-top: 8px; padding-bottom: 8px; }

        /* --- Styling Umum & Halaman --- */
        .view { display: none; }
        .view.active { display: block; }
        .promo-banner-container { margin: 25px 0; border-radius: 15px; overflow: hidden; }
        .promo-banner-container img { width: 100%; display: block; }
        .section-header { margin-top: 20px; margin-bottom: 10px; }
        .section-header h2 { font-size: 0.9rem; font-weight: 600; color: var(--secondary-color); }
        
        /* --- KODE BARU: STYLING FORM PENCARIAN --- */
        .search-section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        .search-form-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .search-form-container input[type="text"],
        .search-form-container select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        .search-form-container input[type="text"] {
            flex-grow: 2; /* Membuat input teks lebih lebar */
        }
        .search-form-container select {
            flex-grow: 1;
        }
        .search-form-container button {
            flex-shrink: 0; /* Mencegah tombol menyusut */
        }
        /* Penyesuaian untuk layar kecil (Mobile) */
        @media (max-width: 600px) {
            .search-form-container {
                flex-direction: column;
                align-items: stretch;
            }
        }
        /* --- AKHIR KODE BARU --- */

        .category-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            padding: 20px;
            border-radius: 15px;
            background-color: var(--white);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        .category-card { text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        .category-card .icon-container {
            width: 80px; height: 80px; margin: 0 auto 10px; background-color: #f0f0f0;
            border-radius: 12px; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s;
        }
        .category-card:hover .icon-container { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .category-card img { width: 100%; height: 100%; object-fit: cover; }
        .category-card p { font-weight: 500; font-size: 0.7rem; }
        .btn { padding: 12px 25px; border: none; border-radius: 5px; font-size: 0.8rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s; text-decoration: none; display: inline-block;}
        .btn-primary { background-color: var(--secondary-color); color: var(--white); }
        .btn-primary:hover { background-color: #055a96; }

        /* Halaman Produk */
        #page-produk .product-page-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 20px; 
        }
        .product-item-card { background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        .product-item-card.out-of-stock { opacity: 0.6; }
        .product-item-card .product-image { width: 100%; cursor: pointer; aspect-ratio: 1/1; object-fit: cover; }
        .product-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .product-name { font-size: 0.7rem; font-weight: bold; color: var(--primary-color); margin-bottom: 15px; flex-grow: 1; }
        .add-to-cart-controls { margin-top: auto; }
        .add-to-cart-btn { 
            width: 100%; background-color: var(--secondary-color); color: var(--white); 
            border: none; border-radius: 5px; padding: 10px; cursor: pointer; 
            font-weight: bold; transition: background-color 0.3s;
        }
        .add-to-cart-btn:hover { background-color: #055a96; }
        .add-to-cart-btn:disabled { background-color: #aaa; }
        
        .quantity-selector { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        .quantity-btn {
            width: 30px; height: 30px; border: 1px solid #ccc; background-color: #f5f5f5;
            cursor: pointer; font-size: 0.8rem; font-weight: bold; line-height: 1;
        }
        .quantity-btn.minus { border-radius: 5px 0 0 5px; }
        .quantity-btn.plus { border-radius: 0 5px 5px 0; }
        .quantity-input {
            width: 50px; height: 30px; text-align: center; border: 1px solid #ccc;
            border-left: none; border-right: none; font-size: 0.8rem;
            -moz-appearance: textfield;
        }
        .quantity-input::-webkit-outer-spin-button, .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .cart-container { padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .cart-item { display: flex; align-items: center; border-bottom: 1px solid var(--gray); padding: 15px 0; gap: 15px; }
        .cart-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; flex-shrink: 0; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-name { font-size: 0.7rem; font-weight: bold; }
        .cart-item-quantity { display: flex; align-items: center; gap: 10px; }
        .quantity-btn.cart { border-radius: 50%; }
        .checkout-form, .cart-actions { margin-top: 30px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; padding: 20px; }
        .popup-content { background-color: var(--white); padding: 20px 30px; border-radius: 8px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #toast-notification { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 5000; left: 50%; transform: translateX(-50%); bottom: 30px; opacity: 0; transition: opacity 0.5s, visibility 0.5s; }
        #toast-notification.show { visibility: visible; opacity: 1; }

        .main-header, .promo-banner-container, .search-section, .section-header, .category-card {
            opacity: 0; visibility: hidden;
        }
        .file-upload-wrapper {
            position: relative; overflow: hidden; display: inline-block;
            width: 100%; margin-top: 5px;
        }
        .file-upload-btn {
            border: 1px solid #ccc; display: inline-block; padding: 8px 12px;
            cursor: pointer; background-color: #f5f5f5; border-radius: 5px;
            width: 100%; text-align: center; font-size: 0.8rem;
        }
        .file-upload-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0;
            opacity: 0; cursor: pointer;
        }
        .file-preview {
            font-size: 0.8rem; margin-top: 5px; color: var(--secondary-color);
        }
        .back-to-menu-link {
            display: inline-block;
            margin-bottom: 25px; /* Memberi jarak ke grid produk di bawahnya */
            font-size: 0.8rem;
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 600;
        }
        .back-to-menu-link:hover {
            text-decoration: underline;
        }
        @media (max-width: 600px) {
            #page-produk .product-page-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .product-info { padding: 10px; }
            .product-name { font-size: 0.7rem; margin-bottom: 8px; }
            .quantity-selector { margin-bottom: 8px; }
            .add-to-cart-btn { padding: 8px; font-size: 0.7rem; }
            .quantity-input { width: 35px; }
        }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: none; /* Defaultnya tersembunyi */
            justify-content: center; align-items: center;
            z-index: 9999;
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color);
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo-container"> <img src="https://yanoshijapan.github.io/jastip/jastip%202.png" alt="Logo Jastip" style="cursor: pointer;" id="logo-home-btn"> </div>
        <div class="header-right"> <a class="cart-icon">ðŸ›’<span id="cart-count">0</span></a> <div class="hamburger-menu">â˜°</div> </div>
    </header>
    <nav id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="close-btn">&times;</a>
        <a class="nav-link" data-page="home">Halaman Utama</a>
        <button class="dropdown-btn">Kategori Produk â–¾</button>
        <div class="dropdown-content">
            <a class="nav-link" data-category="Mie">Aneka Mie</a> <a class="nav-link" data-category="Bumbu">Aneka Bumbu</a> <a class="nav-link" data-category="Sambal">Aneka Sambal</a> <a class="nav-link" data-category="Kopi">Kopi, Teh & Minuman</a> <a class="nav-link" data-category="Snack">Snack & Cemilan</a> <a class="nav-link" data-category="Skincare">Skincare</a> <a class="nav-link" data-category="Sabun">Sabun & Shampo</a> <a class="nav-link" data-category="Rokok">Rokok & Perlengkapan</a> <a class="nav-link" data-category="Request">Request Khusus</a>
        </div>
        <a class="nav-link" data-page="keranjang">Lihat Daftar Pesanan</a>
        <a href="https://wa.me/6281315431551?text=Halo%20Admin%20Jastip" target="_blank">Kontak Admin</a>
    </nav>
    <main class="container">
        <div id="page-utama" class="view active">
            <section class="promo-banner-container"> <img src="https://yanoshijapan.github.io/gambarbelanja/gambars3.png" alt="Promo Banner"> </section>
            
            <section class="search-section">
                <div class="section-header">
                    <h2>Cari Produk</h2>
                </div>
                <form id="search-form" class="search-form-container">
                    <input type="text" id="search-input" placeholder="Ketik nama produk...">
                    <select id="search-category-filter">
                        <option value="Semua">Semua Kategori</option>
                        </select>
                    <button type="submit" class="btn btn-primary">Cari</button>
                </form>
            </section>
            <section class="category-section">
                <div class="section-header"><h2>Pilih Kategori</h2></div>
                <div class="category-grid">
                    <div class="category-card" data-category="Mie"><div class="icon-container"><img src="https://yanoshijapan.github.io/gambarbelanja/anekamie.png"></div><p>Aneka Mie</p></div>
                    <div class="category-card" data-category="Bumbu"><div class="icon-container"><img src="https://yanoshijapan.github.io/gambarbelanja/anekabumbu.png"></div><p>Aneka Bumbu</p></div>
                    <div class="category-card" data-category="Sambal"><div class="icon-container"><img src="https://yanoshijapan.github.io/gambarbelanja/anekasambal.png"></div><p>Sambal, Saus dan Kecap</p></div>
                    <div class="category-card" data-category="Kopi"><div class="icon-container"><img src="https://yanoshijapan.github.io/gambarbelanja/kopi.png"></div><p>Kopi, Teh dan Minuman Sachet</p></div>
                    <div class="category-card" data-category="Snack"><div class="icon-container"><img src="https://yanoshijapan.github.io/gambarbelanja/snack.png"></div><p>Snack dan Cemilan</p></div>
                    <div class="category-card" data-category="Skincare"><div class="icon-container"><img src="https://yanoshijapan.github.io/gambarbelanja/skincare.png"></div><p>Skincare</p></div>
                    <div class="category-card" data-category="Obat"><div class="icon-container"><img src="https://yanoshijapan.github.io/gambarbelanja/sabun.png"></div><p>Obat-Obatan</p></div>
                    <div class="category-card" data-category="Rokok"><div class="icon-container"><img src="https://yanoshijapan.github.io/gambarbelanja/rokok.png"></div><p>Rokok dan Perlengkapan Pribadi</p></div>
                    <div class="category-card" data-category="Request"><div class="icon-container"><img src="https://yanoshijapan.github.io/gambarbelanja/req.png"></div><p>Request Khusus</p></div>
                </div>
            </section>
        </div>
        <div id="page-produk" class="view">
            <h2 id="product-page-title" style="margin-bottom: 20px;"></h2>
            
            <a href="#" class="back-to-menu-link back-to-home">â€¹ Kembali ke Halaman Utama</a>
            
            <div id="product-container" class="product-page-grid"></div>
            <br>
            <a href="#" class="back-to-menu-link back-to-home">â€¹ Kembali ke Halaman Utama</a>
        </div>
        <div id="page-keranjang" class="view">
            <div class="cart-container">
                <h2>List Pesanan Kamu</h2>
                <div id="cart-items-container"><p>List pesanan masih kosong.</p></div>
                <div class="checkout-form">
                    <div class="form-group"><label for="customer-name">Nama Lengkap</label><input type="text" id="customer-name" placeholder="Masukkan nama lengkap"></div>
                    <div class="form-group"><label for="customer-whatsapp">Nomor WhatsApp Aktif</label><input type="tel" id="customer-whatsapp" placeholder="Contoh: 081234567890"></div>
                </div>
                <div class="cart-actions">
                    <button class="back-to-menu-link back-to-home">Tambah Barang Lain</button>
                    <br><br>
                    <button id="checkout-btn" class="btn btn-primary">Kirim List Pesanan</button>
                </div>
            </div>
        </div>
        <div id="page-request" class="view">
            <div class="cart-container">
                <h2>Form Request Khusus</h2>
                <p style="font-size: 0.8rem; margin-bottom: 20px;">
                    Isi nama barang dan upload foto atau gambar untuk barang yang mau kamu request. 
                    Jika barang requestmu kurang dari 5, kamu tidak perlu mengisi semua kolom.
                </p>
                <form id="request-form">
                    <div class="checkout-form">
                        <div class="form-group">
                            <label for="request-customer-name">Nama Lengkap</label>
                            <input type="text" id="request-customer-name" placeholder="Masukkan nama lengkap" required>
                        </div>
                        <div class="form-group">
                            <label for="request-customer-whatsapp">Nomor WhatsApp Aktif</label>
                            <input type="tel" id="request-customer-whatsapp" placeholder="Contoh: 081234567890" required>
                        </div>
                        <hr style="margin: 20px 0;">
                        <div id="request-items-container"></div>
                    </div>
                    <div class="cart-actions" style="display: flex; flex-direction: column; gap: 10px;">
                        <button type="submit" id="submit-request-btn" class="btn btn-primary">Kirim List Request</button>
                        <button type="button" class="back-to-menu-link back-to-home">Kembali ke Halaman Utama</button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    <div id="checkout-popup" class="modal">
        <div class="popup-content">
            <h2>Terima Kasih!</h2>
            <p>List pesananmu kita proses ya! jangan lupa untuk kembali ke form ya!</p><br>  
            <a href="https://yanoshijapan.github.io/jastipindojepang/" id="back-to-form-btn" class="btn" target="_blank" style="background-color: #8e44ad; color: white; margin-top: 10px; width: 100%; box-sizing: border-box;">Kembali ke Form</a>     
        </div>
    </div>
    <div id="notification-popup" class="modal"><div class="popup-content"><p id="notification-message" style="margin-bottom: 20px;"></p><button id="close-notification-btn" class="btn btn-primary">OK</button></div></div>
    <div id="toast-notification"></div>
    <div id="loading-overlay">
        <div class="loader"></div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxVkBEgByOwRZsCG_ON7CMgcuEoDYPqE79BkYIj6JSfdw_l5WmfAWNz1R_WxPpycSuG/exec';
    const ADMIN_WHATSAPP_NUMBER = '6281315431551';
    
    const loadingOverlay = document.getElementById('loading-overlay');
    const showLoader = () => loadingOverlay.style.display = 'flex';
    const hideLoader = () => loadingOverlay.style.display = 'none';

    hideLoader();

    const CATEGORY_DETAILS = { "Mie": { title: "Aneka Mie" }, "Bumbu": { title: "Aneka Bumbu" }, "Sambal": { title: "Aneka Sambal" }, "Kopi": { title: "Kopi, Teh dan Minuman Sachet" }, "Snack": { title: "Snack dan Cemilan" }, "Skincare": { title: "Skincare" }, "Obat": { title: "Obat-Obatan" }, "Rokok": { title: "Rokok dan Perlengkapan Pribadi" } };
    
    // Variabel baru untuk menyimpan semua produk
    let allProducts = [];

    const views = document.querySelectorAll('.view');
    const showView = (viewId) => { views.forEach(v => v.classList.remove('active')); document.getElementById(viewId)?.classList.add('active'); window.scrollTo(0, 0); };
    
    const showProductPage = (cat) => {
        if (cat === 'Request') {
            showView('page-request');
            generateRequestItems();
        } else {
            const det = CATEGORY_DETAILS[cat];
            if (!det) {
                console.error("Kategori tidak ditemukan:", cat);
                return;
            }
            document.getElementById('product-page-title').textContent = det.title;
            showView('page-produk');
            fetchAndRenderProducts(cat);
        }
    };
    
    const fetchAndRenderProducts = (cat) => {
        const pc = document.getElementById('product-container');
        pc.innerHTML = '';
        showLoader();
        fetch(`${WEB_APP_URL}?action=getProducts&category=${cat}`)
            .then(res => res.json())
            .then(res => {
                if (res.status === 'success') renderProducts(res.data);
                else pc.innerHTML = `<p>Gagal memuat produk: ${res.message}</p>`;
            })
            .catch(err => pc.innerHTML = `<p>Error: ${err.message}</p>`)
            .finally(() => hideLoader());
    };

    // Fungsi baru untuk mengambil SEMUA produk dan menyimpannya
    const fetchAllProductsAndSetupSearch = async () => {
        showLoader();
        const categoryKeys = Object.keys(CATEGORY_DETAILS);
        const searchCategoryFilter = document.getElementById('search-category-filter');

        // Mengisi dropdown kategori di form pencarian
        categoryKeys.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = CATEGORY_DETAILS[cat].title;
            searchCategoryFilter.appendChild(option);
        });

        const promises = categoryKeys.map(category =>
            fetch(`${WEB_APP_URL}?action=getProducts&category=${category}`)
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    // Menambahkan properti kategori ke setiap produk
                    return result.data.map(product => ({ ...product, category: category }));
                }
                return [];
            })
        );
        
        try {
            const results = await Promise.all(promises);
            allProducts = results.flat(); // Menggabungkan semua array produk menjadi satu
        } catch (error) {
            console.error("Gagal mengambil semua produk:", error);
            showNotificationPopup("Gagal memuat data produk untuk pencarian.");
        } finally {
            hideLoader();
        }
    };
    
    // Event listener untuk form pencarian
    document.getElementById('search-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const selectedCategory = document.getElementById('search-category-filter').value;

        let filteredProducts = allProducts.filter(product => {
            const nameMatch = product.name.toLowerCase().includes(searchTerm);
            const categoryMatch = (selectedCategory === 'Semua') || (product.category === selectedCategory);
            return nameMatch && categoryMatch;
        });

        showView('page-produk');
        document.getElementById('product-page-title').textContent = `Hasil Pencarian untuk "${searchTerm}"`;
        renderProducts(filteredProducts);
    });

    const renderProducts = (products) => { const pc = document.getElementById('product-container'); pc.innerHTML = ''; if (products.length === 0) { pc.innerHTML = `<p>Produk tidak ditemukan.</p>`; return; } products.forEach(p => { const oos = p.stock <= 0; const card = document.createElement('div'); card.className = `product-item-card ${oos ? 'out-of-stock' : ''}`; card.innerHTML = `<img src="${p.image}" alt="${p.name}" class="product-image"><div class="product-info"><div class="product-name">${p.name}</div><div class="quantity-selector"><button type="button" class="quantity-btn minus" onclick="changeProductQuantity(this, -1)" ${oos ? 'disabled' : ''}>-</button><input type="number" class="quantity-input" value="1" min="1" ${oos ? 'disabled' : ''}><button type="button" class="quantity-btn plus" onclick="changeProductQuantity(this, 1)" ${oos ? 'disabled' : ''}>+</button></div><div class="add-to-cart-controls"><button class="add-to-cart-btn" onclick="addToCart(this, '${p.productId}')" ${oos ? 'disabled' : ''}>${oos ? 'Stok Habis' : 'Tambah ke Keranjang'}</button></div></div>`; pc.appendChild(card); }); };
    window.changeProductQuantity = (button, change) => { const selector = button.parentElement; const input = selector.querySelector('.quantity-input'); let currentValue = parseInt(input.value, 10); let newValue = currentValue + change; if (newValue < 1) { newValue = 1; } input.value = newValue; };
    window.addToCart = (button, productId) => { const card = button.closest('.product-item-card'); const name = card.querySelector('.product-name').textContent; const image = card.querySelector('.product-image').src; const quantityInput = card.querySelector('.quantity-input'); const quantity = parseInt(quantityInput.value, 10); if (quantity < 1) { showToast("Jumlah minimal adalah 1"); return; } let cart = getCart(); const existingItem = cart.find(item => item.id === productId); if (existingItem) { existingItem.quantity += quantity; } else { cart.push({ id: productId, name, image, quantity: quantity }); } saveCart(cart); showToast(`${quantity}x ${name} ditambahkan`); quantityInput.value = 1; };
    const getCart = () => JSON.parse(localStorage.getItem('jastipCartSimple')) || [];
    const saveCart = (cart) => { localStorage.setItem('jastipCartSimple', JSON.stringify(cart)); updateCartIcon(); };
    const updateCartIcon = () => { const el = document.getElementById('cart-count'); const total = getCart().reduce((s, i) => s + i.quantity, 0); el.textContent = total; el.style.display = total > 0 ? 'block' : 'none'; };
    const renderCartPage = () => { const cart = getCart(); const cont = document.getElementById('cart-items-container'); cont.innerHTML = ''; if (cart.length === 0) { cont.innerHTML = '<p>Daftar pesanan masih kosong.</p>'; document.getElementById('checkout-btn').disabled = true; return; } document.getElementById('checkout-btn').disabled = false; cart.forEach(item => { const el = document.createElement('div'); el.className = 'cart-item'; el.innerHTML = `<img src="${item.image}" alt="${item.name}" class="cart-item-img"><div class="cart-item-details"><div class="cart-item-name">${item.name}</div></div><div class="cart-item-quantity"><button class="quantity-btn cart" onclick="updateQuantity('${item.id}', -1)">-</button><span>${item.quantity}</span><button class="quantity-btn cart" onclick="updateQuantity('${item.id}', 1)">+</button></div>`; cont.appendChild(el); }); };
    window.updateQuantity = (id, chg) => { let cart = getCart(); const idx = cart.findIndex(i => i.id === id); if (idx > -1) { cart[idx].quantity += chg; if (cart[idx].quantity <= 0) cart.splice(idx, 1); } saveCart(cart); renderCartPage(); };
    
    document.getElementById('checkout-btn').addEventListener('click', () => { 
        const name = document.getElementById('customer-name').value.trim(); 
        const whatsapp = document.getElementById('customer-whatsapp').value.trim(); 
        if (!name || !whatsapp) { showNotificationPopup('Lengkapi Nama & WhatsApp.'); return; } 
        const cart = getCart(); 
        if (cart.length === 0) return; 
        showLoader();
        let details = `*Pesanan dari ${name}*\n\n`; 
        cart.forEach(item => { details += `- ${item.name} (Qty: ${item.quantity})\n`; }); 
        details += `\nMohon diproses.`; 
        document.getElementById('konfirmasi-wa-btn').href = `https://wa.me/${ADMIN_WHATSAPP_NUMBER}?text=${encodeURIComponent(details)}`; 
        const data = { action: 'newOrder', name, whatsapp, items: cart }; 
        fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(data) })
        .then(res => res.json()).then(result => { 
            if (result.status === 'success') { 
                saveCart([]); 
                document.getElementById('checkout-popup').style.display = 'flex'; 
            } else { 
                showNotificationPopup('Gagal: ' + result.message); 
            } 
        }).catch(err => showNotificationPopup('Error: ' + err.message)).finally(() => hideLoader());
    });

    const initializeNav = () => { document.querySelector('.hamburger-menu').addEventListener('click', () => { document.getElementById('mySidenav').style.width = '250px'; }); document.querySelector('.close-btn').addEventListener('click', () => { document.getElementById('mySidenav').style.width = '0'; }); document.querySelector('#mySidenav .dropdown-btn').addEventListener('click', function() { this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'block' ? 'none' : 'block'; }); document.querySelectorAll('.nav-link').forEach(link => { link.addEventListener('click', (e) => { const page = e.currentTarget.dataset.page; const category = e.currentTarget.dataset.category; if (page) { if (page === 'keranjang') renderCartPage(); showView(`page-${page}`); } if (category) { showProductPage(category); } if (link.parentElement.classList.contains('dropdown-content') || !link.classList.contains('dropdown-btn')) { document.getElementById('mySidenav').style.width = '0'; } }); }); document.querySelectorAll('.category-card').forEach(card => card.addEventListener('click', () => showProductPage(card.dataset.category))); document.querySelectorAll('.back-to-home, #logo-home-btn').forEach(btn => btn.addEventListener('click', (e) => { e.preventDefault(); showView('page-utama'); document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); })); document.querySelector('.cart-icon').addEventListener('click', () => { renderCartPage(); showView('page-keranjang'); }); };
    let toastTimeout;
    const showToast = (msg) => { const toast = document.getElementById('toast-notification'); toast.textContent = msg; toast.classList.add('show'); clearTimeout(toastTimeout); toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 2000); };
    const showNotificationPopup = (msg) => { document.getElementById('notification-message').textContent = msg; document.getElementById('notification-popup').style.display = 'flex'; };
    document.getElementById('close-notification-btn').onclick = () => { document.getElementById('notification-popup').style.display = "none"; }

    const generateRequestItems = () => {
        const container = document.getElementById('request-items-container');
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'form-group';
            itemDiv.innerHTML = `
                <label>Barang Request ${i}</label>
                <input type="text" class="request-item-name" placeholder="Nama Barang (opsional)">
                <div class="file-upload-wrapper">
                    <div class="file-upload-btn">Upload Foto</div>
                    <input type="file" class="request-item-file" accept="image/*" onchange="updateFileName(this)">
                </div>
                <div class="file-preview">Tidak ada file dipilih</div>
            `;
            container.appendChild(itemDiv);
        }
    };

    window.updateFileName = (input) => {
        const preview = input.parentElement.nextElementSibling;
        if (input.files.length > 0) {
            preview.textContent = input.files[0].name;
        } else {
            preview.textContent = 'Tidak ada file dipilih';
        }
    };

    const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    document.getElementById('request-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('request-customer-name').value.trim();
        const whatsapp = document.getElementById('request-customer-whatsapp').value.trim();
        if (!name || !whatsapp) {
            showNotificationPopup('Lengkapi Nama & WhatsApp.');
            return;
        }
        showLoader();
        const requestItems = [];
        const itemInputs = document.querySelectorAll('#request-items-container .form-group');
        let hasContent = false;
        for (const itemInput of itemInputs) {
            const itemName = itemInput.querySelector('.request-item-name').value.trim();
            const fileInput = itemInput.querySelector('.request-item-file');
            let fileData = null;
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const base64 = await fileToBase64(file);
                fileData = {
                    fileName: file.name,
                    mimeType: file.type,
                    content: base64
                };
            }
            if (itemName || fileData) {
                hasContent = true;
                requestItems.push({ name: itemName, file: fileData });
            }
        }
        
        if (!hasContent) {
            hideLoader();
            showNotificationPopup('Mohon isi minimal satu nama barang atau upload satu foto.');
            return;
        }
        const data = {
            action: 'newRequest',
            name,
            whatsapp,
            items: requestItems
        };
        let details = `*Request Khusus dari ${name}*\n\n`;
        requestItems.forEach((item, index) => {
            details += `- Barang ${index + 1}: ${item.name || '(tidak ada nama)'} (${item.file ? 'ada foto' : 'tidak ada foto'})\n`;
        });
        details += `\nMohon dicek.`;
        document.getElementById('konfirmasi-wa-btn').href = `https://wa.me/${ADMIN_WHATSAPP_NUMBER}?text=${encodeURIComponent(details)}`;
        fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(data) })
        .then(res => res.json()).then(result => {
            if (result.status === 'success') {
                document.getElementById('checkout-popup').style.display = 'flex';
                document.getElementById('request-form').reset();
                document.querySelectorAll('.file-preview').forEach(p => p.textContent = 'Tidak ada file dipilih');
            } else {
                showNotificationPopup('Gagal: ' + result.message);
            }
        }).catch(err => showNotificationPopup('Error: ' + err.message)).finally(() => hideLoader());
    });
    
    initializeNav();
    updateCartIcon();
    showView('page-utama');
    
    // Panggil fungsi untuk mengambil semua produk saat halaman dimuat
    fetchAllProductsAndSetupSearch();

    // Animasi GSAP
    const tl = gsap.timeline({ defaults: { ease: "power2.out" } });
    tl.fromTo(".main-header", { y: -50 }, { y: 0, opacity: 1, visibility: "visible", duration: 0.8 }, "+=0.2")
      .fromTo(".promo-banner-container", { scale: 0.9 }, { scale: 1, opacity: 1, visibility: "visible", duration: 0.7 }, "-=0.3")
      // Tambahkan animasi untuk search section
      .fromTo(".search-section", { y: 20, opacity: 0 }, { y: 0, opacity: 1, visibility: "visible", duration: 0.5 }, "-=0.4")
      .fromTo(".section-header", { y: 20 }, { y: 0, opacity: 1, visibility: "visible", duration: 0.5 }, "-=0.4")
      .fromTo(".category-card", { y: 20, opacity: 0 }, { y: 0, opacity: 1, visibility: "visible", duration: 0.5, stagger: 0.1 }, "-=0.3");
});
</script>

</body>
</html>
